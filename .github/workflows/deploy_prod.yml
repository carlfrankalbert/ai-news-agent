name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        default: 'prod'
        type: choice
        options:
          - prod
          - production

jobs:
  deploy:
    name: Deploy to Prod
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run tests
        run: |
          python -c "import main; print('âœ… Import successful')"
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      
      - name: Run prod deployment
        run: |
          python main.py
          python generate_html.py
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ENVIRONMENT: prod
      
      - name: Get git SHA
        id: git_sha
        run: |
          echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
      
      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: ai-news-agent
          directory: docs
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}
          wranglerVersion: '3'
      
      - name: Wait for deployment
        run: |
          sleep 10
      
      - name: Health check
        id: healthcheck
        run: |
          DOMAIN="${{ secrets.PROD_DOMAIN || 'ai-news-agent.pages.dev' }}"
          URL="https://${DOMAIN}/health"
          
          echo "Checking health at: $URL"
          
          for i in {1..5}; do
            if curl -f -s "$URL" > /dev/null; then
              echo "âœ… Health check passed"
              echo "status=success" >> $GITHUB_OUTPUT
              exit 0
            fi
            echo "Attempt $i failed, retrying in 5 seconds..."
            sleep 5
          done
          
          echo "âŒ Health check failed after 5 attempts"
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1
      
      - name: Rollback on health check failure
        if: steps.healthcheck.outputs.status == 'failed'
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: ai-news-agent
          directory: docs
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}
          wranglerVersion: '3'
          rollback: true
      
      - name: Archive prod data
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: prod_cache
          path: output/prod_cache.json
          retention-days: 30
      
      - name: Send Slack notification
        if: always()
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "text": "ðŸš€ Production Deployment ${{ job.status }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Production Deployment ${{ job.status }}*\n\nâ€¢ Environment: Production\nâ€¢ Commit: ${{ steps.git_sha.outputs.sha }}\nâ€¢ Build: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\nâ€¢ URL: https://${{ secrets.PROD_DOMAIN || 'ai-news-agent.pages.dev' }}"
                  }
                }
              ]
            }

